# Building and Deploying Drupal with Gulp and Docker

## intro

Four Kitchens. *Change the world by setting knowledge free.*

### Patrick Coffey -- Engineer
![](http://fourkitchens.com/img/team/avatar/patrick-coffey.png)

### Matthew Grill -- Engineer & Pirate of technology
![](http://fourkitchens.com/img/team/avatar/matt-grill.png)

# what is drupalcraft?
 * A Drupal build/test system.
 * Source tree structure for a project that mandates good organization and excludes Drupal core from the repo.
 * Pluggable deployment options so that building and deploying becomes a one-step action.
 * Code sniffing tools that enables developers to consistenly write complient code.
 * Extendable Gulp-based command line interface powers everything.

## existing options
* Pantheon MultiDev
  * Offers deployment, but no build/test tools.
  * Good candidate for a deployment extension for drupalcraft!
* Acquia
  * Again, offers eployment, but no build/test tools.
  * Also a good candidate for a deployment extension for drupalcraft!
* Travis/Circle
  * Testing, but no deployment options.
* Jenkins
  * Odd.
  * Difficult to set up and configure.
  * Steep learning curve.
* [Phase2 Drupal-Grunt-Tasks](https://2014.badcamp.net/session/using-grunt-manage-drupal-build-and-testing-tools)
  * Docker support?
  * Structure is such that extension is confusing and difficult.
  * Gulp is easier to understand and work with. It's also more performant.

## benefits of building drupal from scratch
* Separate Drupal core code from custom code.
* Core files never introduced into project repository.
* Codebase is more stable:
  * Code is written to build correctly each time, hands off.
  * Structural weaknesses (like faulty update hooks) can be discovered during the build process.
  * Forces you to express your entire site structure in code (otherwise it won't exist on when you build)

## command line tools
* Real-time automated code linting, ensures syntax consistency and enforces Drupal Coding Standards.
* Automated unit and functional testing (**Still in progress**).
* Simple (pluggable) cli tool for building site, and deploying to both local and remote environments.

## docker

Yo dog I hear you like virtualization? Write once, deploy anywhere.

**Docker is not a replacement for your development environment.**

Virtual barriers between multiple virtual environments running in the same physical environment.

### virtual machines

> Each virtualized application includes not only the application - which may be only 10s of MB - and the necessary binaries and libraries, but also an entire guest operating system - which may weigh 10s of GB.

### docker

> The Docker Engine container comprises just the application and its dependencies. It runs as an isolated process in user-space on the host operating system, sharing the kernel with other containers. Thus, it enjoys the resource isolation and allocation benefits of VMs but is much more portable and efficient.

We wanted to use this.

SANDCamp 2014 -> Drupal <3 Docker.

SANDCamp 2015 -> Building and Deploying Drupal with Gulp and Docker. (WT)

### gulp

a lot like Grunt, maybe.

* build with streams
* concurrency
* code not config

all methods are managed with gulp. you only need to know one set of commands. easy expert

## why did we make this?

opinionated. 

we wanted to make something that that fit out personalities, some people might agree.

gulp & docker are a perfect fit.

two major components to this, local build environment, and remote 'deploy environment', docker.

```
     __                   __             _____ 
 ___/ /_____ _____  ___ _/ /__________ _/ _/ /_
/ _  / __/ // / _ \/ _ `/ / __/ __/ _ `/ _/ __/
\_,_/_/  \_,_/ .__/\_,_/_/\__/_/  \_,_/_/ \__/ 
            /_/                                
```


```javascript
/**
 * @task build.install
 *   Runs Drupal installation scripts.
 */
gulp.task('build.install', ['build.template'], function() {
  var builddir = 'builds/' + options.builddir;
  return gulp.src('')
          .pipe(shell('cd ' + builddir + '&& drush si -y --account-pass=admin && drush -y en master'))
          .pipe(shell('cd ' + builddir + '&& drush master-set-current-scope ' + options.scope + ' && drush -y master-execute'));
});
```

> not just development tasks. includes a series of tasks for coding standards.

```javascript
/**
 * @task phpcs
 *   Runs PHPCS on all module and theme PHP. PHP bin set to the
 *   /usr/local/bin/phpcs exe by default, but should be updated to
 *   wherever your phpcs exe is located.
 */
gulp.task('phpcs', function () {
  return gulp.src([
    'modules/**/*.php',
    'modules/**/*.module',
    'modules/**/*.inc',
    'modules/**/*.install',
    'themes/**/*.php',

    // Ignore files automatically generated by features.
    '!modules/**/*.features.inc',
    '!modules/**/*.features.*.inc',
    '!modules/**/*.strongarm.inc',
    '!modules/**/*.views_default.inc',
    '!modules/**/*.field_group.inc',
    '!modules/**/*.context.inc'
  ])
  .pipe(phpcs({
    bin: '`which phpcs`',
    standard: 'sites/all/modules/contrib/coder/coder_sniffer/Drupal',
    warningSeverity: 0
  }))
  .pipe(phpcs.reporter('log'))
  .pipe(phpcs.reporter('fail'));
});
```

## what about deployment

* docker rest api

```javascript
request.post({
    'url'   : 'http://unix:/var/run/docker.sock:/containers/create?name=' + options.details.name,
    'body'  : JSON.stringify(containerInfo)
  }, function (error, response, body) {
    if (error) {
      deferred.reject(new Error(error));
      debug('An issue occurred while trying to create the docker container.');
      debug(error);
    }
    options.docker.container    = JSON.parse(body);
    deferred.resolve(options);
  });
```

* super-fast startup
  * starting from a pre-baked image.
  * drupal <3 docker 1.0

```Dockerfile
# Start from the Phusion Base Image
FROM phusion/baseimage:0.9.15

# Set correct environment variables.
ENV HOME /root
ENV DEBIAN_FRONTEND noninteractive

# Regenerate SSH host keys. baseimage-docker does not contain any, so you
# have to do that yourself. You may also comment out this instruction; the
# init system will auto-generate one during boot.
RUN /etc/my_init.d/00_regen_ssh_host_keys.sh

# UPATE APT-GET
RUN apt-get update

# SSH
# Do SSH things..

##
## BUILD
##

# INSTALL SUPERVISOR
RUN apt-get install -y supervisor
RUN mkdir -p /var/log/supervisor

# INSTALL APACHE 2
RUN apt-get install -y apache2

# INSTALL PHP-THINGS
RUN apt-get install -y libapache2-mod-php5 php5-mysql php-apc php5-gd php5-memcache memcached php-pear

# INSTALL DRUSH
RUN pear channel-discover pear.drush.org && pear install drush/drush

# INSTALL GIT
RUN apt-get install -y git

##
## CONFIGURATION
##

# SUPERVISOR CONF
ADD conf/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# APACHE CONFIGURATION
RUN ln -s /etc/apache2/mods-available/rewrite.load /etc/apache2/mods-enabled/rewrite.load
RUN rm -f /etc/apache2/sites-enabled/000-default.conf
ADD conf/drupal.conf /etc/apache2/sites-available/drupal.conf
RUN ln -s /etc/apache2/sites-available/drupal.conf /etc/apache2/sites-enabled/drupal.conf

# Clean up APT when done.
RUN apt-get clean && rm -rf /var/lib/apt/lists/* /var/tmp/*

# EXPOSE 22 80
EXPOSE 22 80

# WHAT THE CONTAINER RUNS
CMD ["/usr/bin/supervisord"]

# docker run -v /var/run/mysqld/mysqld.sock:/var/run/mysqld/mysqld.sock -v ~/docker/mount:/tmp/www -p 80 -p 22 -d 6c3a57612039
```

* management all over http

```nginx.conf
# DOCKER REST API
upstream docker {
  server unix:/var/run/docker.sock fail_timeout=0;
}
server {
  listen 8080;
  listen [::]:8080 ipv6only=on;

  # Make site accessible from http://localhost/
  server_name localhost;

   location / {
      proxy_pass                  http://docker;
      proxy_redirect              off;

      proxy_set_header            Host             $host;
      proxy_set_header            X-Real-IP        $remote_addr;
      proxy_set_header            X-Forwarded-For  $proxy_add_x_forwarded_for;

      client_max_body_size        10m;
      client_body_buffer_size     128k;

      proxy_connect_timeout       90;
      proxy_send_timeout          120;
      proxy_read_timeout          120;

      proxy_buffer_size           4k;
      proxy_buffers               4 32k;
      proxy_busy_buffers_size     64k;
      proxy_temp_file_write_size  64k;
   }
}
```

* mysql 
  * db/user/pass unique to each build environment 

## upcoming features of drupalcraft
* We're still working on drupalcraft. Lots of things are coming!
* More deployment options (Pantheon, aquia, heroku, etc)
* Automated testing.
  * Command-line tools that enable easy unit and functional (behat) testing.
  * Testing integrated into build system. Testing fails, build fails.
  * Git hooks that run tests when a commit is being formed.
* Migration tools that will allow you to define test sets of data.
* Performance auditing tools (deep Site Audit integration).







